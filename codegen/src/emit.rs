//! Rust source code emitter.
//!
//! Builds up Rust source files as strings and writes them to disk.

use std::fmt::Write as FmtWrite;
use std::path::Path;

use anyhow::{Context, Result};

/// A builder for a single Rust source file.
pub struct RustFile {
    /// The internal buffer. Public for `writeln!` usage in sibling modules.
    pub buf: String,
}

impl RustFile {
    /// Creates a new Rust file with the `@generated` header.
    pub fn new(module_doc: &str) -> Self {
        let mut buf = String::with_capacity(4096);
        buf.push_str("// @generated by uor-crate from uor-ontology â€” do not edit manually\n\n");
        buf.push_str(&format!("//! {module_doc}\n\n"));
        Self { buf }
    }

    /// Appends a raw line.
    pub fn line(&mut self, s: &str) {
        self.buf.push_str(s);
        self.buf.push('\n');
    }

    /// Appends a blank line.
    pub fn blank(&mut self) {
        self.buf.push('\n');
    }

    /// Appends a doc comment.
    pub fn doc_comment(&mut self, comment: &str) {
        for line in comment.lines() {
            let _ = writeln!(self.buf, "/// {line}");
        }
    }

    /// Appends an indented doc comment (4 spaces, for inside trait/impl bodies).
    pub fn indented_doc_comment(&mut self, comment: &str) {
        for line in comment.lines() {
            let _ = writeln!(self.buf, "    /// {line}");
        }
    }

    /// Appends a module-level doc comment line.
    pub fn module_doc(&mut self, comment: &str) {
        let _ = writeln!(self.buf, "//! {comment}");
    }

    /// Returns the built source as a string, with trailing whitespace trimmed.
    pub fn finish(self) -> String {
        let trimmed = self.buf.trim_end();
        format!("{trimmed}\n")
    }
}

/// Writes a Rust source file to disk, creating parent directories as needed.
///
/// # Errors
///
/// Returns an error if the directory cannot be created or the file cannot be written.
pub fn write_file(path: &Path, content: &str) -> Result<()> {
    if let Some(parent) = path.parent() {
        std::fs::create_dir_all(parent)
            .with_context(|| format!("Failed to create directory: {}", parent.display()))?;
    }
    std::fs::write(path, content)
        .with_context(|| format!("Failed to write: {}", path.display()))?;
    Ok(())
}

/// Wraps a comment string for doc comments: collapses internal whitespace runs
/// and escapes brackets to avoid false rustdoc intra-doc link warnings.
pub fn normalize_comment(s: &str) -> String {
    let collapsed = s.split_whitespace().collect::<Vec<_>>().join(" ");
    // Escape [ and ] to prevent rustdoc from interpreting them as intra-doc links
    collapsed.replace('[', r"\[").replace(']', r"\]")
}
